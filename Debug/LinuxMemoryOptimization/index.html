<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux 内存优化 | Matrix</title><meta name="author" content="CarlyleLiu"><meta name="copyright" content="CarlyleLiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="内存使用情况分析DRAM 大小硬件上 DDR 确定之后， DRAM 大小就已经确定。 uboot 会根据 DRAM 驱动提供的接口获取 DRAM 的大小，然后修改 dts 中的 memory 节点，Linux 启动时解析 dts 获取 DRAM 的大小。uboot 启动 log 中会打印 dram 的大小。比如 R329 方案 uboot 启动时会有如下 log： 1[01.300]DRAM: 1">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 内存优化">
<meta property="og:url" content="https://carlyleliu.github.io/Debug/LinuxMemoryOptimization/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="内存使用情况分析DRAM 大小硬件上 DDR 确定之后， DRAM 大小就已经确定。 uboot 会根据 DRAM 驱动提供的接口获取 DRAM 的大小，然后修改 dts 中的 memory 节点，Linux 启动时解析 dts 获取 DRAM 的大小。uboot 启动 log 中会打印 dram 的大小。比如 R329 方案 uboot 启动时会有如下 log： 1[01.300]DRAM: 1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://unsplash.it/1600/900?random&2923">
<meta property="article:published_time" content="2019-03-01T14:38:04.000Z">
<meta property="article:modified_time" content="2025-09-27T04:36:15.395Z">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Programming">
<meta property="article:tag" content="Debug">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Performance">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://unsplash.it/1600/900?random&2923"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://carlyleliu.github.io/Debug/LinuxMemoryOptimization/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux 内存优化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-27 12:36:15'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">194</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://unsplash.it/1600/900?random&amp;2923')"><nav id="nav"><span id="blog-info"><a href="/" title="Matrix"><span class="site-name">Matrix</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux 内存优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-03-01T14:38:04.000Z" title="发表于 2019-03-01 22:38:04">2019-03-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-27T04:36:15.395Z" title="更新于 2025-09-27 12:36:15">2025-09-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/Programming/">Programming</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/Programming/Performance/">Performance</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Linux 内存优化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="内存使用情况分析"><a href="#内存使用情况分析" class="headerlink" title="内存使用情况分析"></a>内存使用情况分析</h1><h2 id="DRAM-大小"><a href="#DRAM-大小" class="headerlink" title="DRAM 大小"></a>DRAM 大小</h2><p>硬件上 DDR 确定之后， DRAM 大小就已经确定。</p>
<p>uboot 会根据 DRAM 驱动提供的接口获取 DRAM 的大小，然后修改 dts 中的 memory 节点，Linux 启动时解析 dts 获取 DRAM 的大小。<br>uboot 启动 log 中会打印 dram 的大小。比如 R329 方案 uboot 启动时会有如下 log：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[01.300]DRAM: 128 MiB</span><br></pre></td></tr></tbody></table></figure>
<p>执行：<br></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># hexdump -C /sys/firmware/devicetree/base/memory@40000000/reg</span></span><br><span class="line">00000000 00 00 00 00 40 00 00 00 00 00 00 00 08 00 00 00 |....@...........|</span><br><span class="line">00000010</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>也可以获取 dram 的起始地址与大小。如下面 R329 例子所示，其中 0x40000000 为起始地址， 0x08000000 为 dram 的 size.</p>
<span id="more"></span>
<h2 id="系统内存使用情况"><a href="#系统内存使用情况" class="headerlink" title="系统内存使用情况"></a>系统内存使用情况</h2><h3 id="free-命令"><a href="#free-命令" class="headerlink" title="free 命令"></a>free 命令</h3><p>进入 Linux 用户空间，执行 free 命令可获得当前系统的内存使用情况。比如 R329 方案，某次执行 free 命令的结果如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># free</span></span><br><span class="line">total used free shared buffers cached</span><br><span class="line">Mem: 110592 79960 30632 36 9172 22860</span><br><span class="line">-/+ buffers/cache: 47928 62664</span><br><span class="line">Swap: 0 0 0</span><br></pre></td></tr></tbody></table></figure>
<p>free 命令输出说明如下：</p>
<h4 id="第一行-Mem，当前系统内存的使用情况"><a href="#第一行-Mem，当前系统内存的使用情况" class="headerlink" title="第一行 Mem，当前系统内存的使用情况"></a>第一行 Mem，当前系统内存的使用情况</h4><ul>
<li>total： Linux 内核可支配的内存</li>
<li>used：系统已使用的内存</li>
<li>free：系统尚未使用的内存</li>
<li>shared：共享内存以及 tmpfs、 devtmpfs 所占用的内存。共享内存指使用 shmget、shm_open、 mmap 等接口创建的共享内存</li>
<li>buffers： Buffers 表示块设备 block device 所占用的缓存页，包括直接读写块设备、以及文件系统元数据 metadata 等</li>
<li>cached： Cache 里包括所有与文件对应的内存页。如果一个文件不再与进程关联，该文件不会立即回收，此时仍然包含在 Cached 中；此外， Cached 中还包含 tmpfs 中的文件以及 shmem 等</li>
</ul>
<h4 id="第二行"><a href="#第二行" class="headerlink" title="第二行"></a>第二行</h4><p>-/+ buffers/cache，减号表示第一行 used 内存减去 buffers 与 cached 内存，即 Mem_used - Mem_buffers - Mem_cached；<br>加号表示第一行 free 内存加上 buffers 与 cached 内存，即 Mem_free + Mem_buffers + Mem_cached。从应用程序的角度看， buffers 和 cached 是潜在可用的内存。</p>
<h4 id="第三行-Swap，交换分区的使用情况"><a href="#第三行-Swap，交换分区的使用情况" class="headerlink" title="第三行 Swap，交换分区的使用情况"></a>第三行 Swap，交换分区的使用情况</h4><p>Tina 产品上使用 flash 作为存储器，读写次数是有限的，而 swap 分区特点是会被频繁地读写，导致 flash 寿命变短，因此 tina 上没有创建 swap 分区。</p>
<ul>
<li>total: 交换分区总大小</li>
<li>used: 已使用的交换分区大小</li>
<li>free: 空闲的交换分区大小</li>
</ul>
<h3 id="proc-meminfo-节点"><a href="#proc-meminfo-节点" class="headerlink" title="/proc/meminfo 节点"></a>/proc/meminfo 节点</h3><p>实际上 free 命令信息来源是从/proc/meminfo 节点。比如 R329 方案，某次执行 cat /proc/meminfo 命令的结果如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># cat /proc/meminfo</span></span><br><span class="line">MemTotal: 110592 kB</span><br><span class="line">MemFree: 30380 kB</span><br><span class="line">MemAvailable: 62044 kB</span><br><span class="line">Buffers: 9276 kB</span><br><span class="line">Cached: 22872 kB</span><br><span class="line">SwapCached: 0 kB</span><br><span class="line">Active: 17580 kB</span><br><span class="line">Inactive: 16336 kB</span><br><span class="line">Active(anon): 1780 kB</span><br><span class="line">Inactive(anon): 24 kB</span><br><span class="line">Active(file): 15800 kB</span><br><span class="line">Inactive(file): 16312 kB</span><br><span class="line">Unevictable: 0 kB</span><br><span class="line">Mlocked: 0 kB</span><br><span class="line">SwapTotal: 0 kB</span><br><span class="line">SwapFree: 0 kB</span><br><span class="line">Dirty: 0 kB</span><br><span class="line">Writeback: 0 kB</span><br><span class="line">AnonPages: 1800 kB</span><br><span class="line">Mapped: 3324 kB</span><br><span class="line">Shmem: 36 kB</span><br><span class="line">Slab: 13536 kB</span><br><span class="line">SReclaimable: 4224 kB</span><br><span class="line">SUnreclaim: 9312 kB</span><br><span class="line">KernelStack: 1232 kB</span><br><span class="line">PageTables: 200 kB</span><br><span class="line">NFS_Unstable: 0 kB</span><br><span class="line">Bounce: 0 kB</span><br><span class="line">WritebackTmp: 0 kB</span><br><span class="line">CommitLimit: 55296 kB</span><br><span class="line">Committed_AS: 29116 kB</span><br><span class="line">VmallocTotal: 263061440 kB</span><br><span class="line">VmallocUsed: 0 kB</span><br><span class="line">VmallocChunk: 0 kB</span><br><span class="line">CmaTotal: 24576 kB</span><br><span class="line">CmaFree: 2684 kB</span><br></pre></td></tr></tbody></table></figure>
<p>相关说明如下：</p>
<ul>
<li>MemTotal、 MemFree、 Buffers、 Cached、 Shmem，即 free 命令第一行。</li>
<li>MemAvailable：使用 MemFree, Active(file), Inactive(file), SReclaimable 和/proc/zoneinfo 中的 low watermark 根据特定算法计算得出，是一个估值，并不精确。可用来评估应用程序层面可用的内存。</li>
<li>Active/Inactive： Active 表示最近使用的内存，回收的优先级低； Inactive 表示最近较少使用的内存，回收的优先级高。可细分为 Active/Inactive 匿名页与文件页。所谓文件页，就是与文件对应的内存页，如进程的代码、映射的文件都属于文件页，当内存不足时，这部分的内存可以写回到存储器中；与之对应的就属于匿名页，即没有与具体文件对应的页，如进程的堆栈等，内存不足时，如果存在 swap 分区，可以将匿名页写入到交换分区，如果没有 swap 分区，则只能常驻内存中。</li>
<li>AnonPages：匿名页。</li>
<li>Mapped：设备或文件映射的大小。比如共享内存、动态库、 mmap 的文件等都统计在该内存中。</li>
<li>slab/SReclaimable/SUnreclaim：内核 slab 使用的内存，包含可回收与不可回收部分。</li>
<li>KernelStack：内核栈大小。</li>
<li>PageTables：页表的大小（用于将虚拟地址翻译为物理地址），内存分配越多，此块内存就会增大。</li>
<li>CommitLimit/Committed_AS： overcommit 的阈值/已经申请的内存大小（不是已分配）。 Overcommit 是 Linux 一种内存申请处理方式，为了跑更多更大的程序，大部分申请内存的请求都回复 “yes”，总申请的内存大于总物理内存。</li>
<li>VmallocTotal/VmallocUsed/VmallocChunk： vmalloc 区 域 大 小/vmalloc 区 域 使 用大小/vmalloc 区域中最大可用的连续区块大小。这部分在新版本内核上移除了。</li>
<li>CmaTotal/CmaFree：总 CMA 内存/空闲 CMA 内存。</li>
</ul>
<h2 id="保留内存"><a href="#保留内存" class="headerlink" title="保留内存"></a>保留内存</h2><p>R329 DRAM 大小为 128M，而 free 命令中显示系统可支配总内存只有 110592KB=108M，为什么？<br>这里就涉及到一个概念：保留内存（Reserved Memory）。保留内存是指把系统中的一部分内存保留起来用作特殊用途，这部分内存通常不会被释放，也不会被转移到交换分区。</p>
<p>进入控制台，执行 cat /sys/kernel/debug/memblock/reserved 可以查看 reserved memory 使用情况：当前 R329 reserved memory 使用情况如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@TinaLinux:/<span class="comment"># cat /sys/kernel/debug/memblock/reserved</span></span><br><span class="line">0: 0x0000000040080000..0x00000000408a3fff, size:8336K</span><br><span class="line">1: 0x00000000408a5000..0x00000000408a5fff, size:4K</span><br><span class="line">2: 0x0000000041700000..0x000000004171767f, size:93K</span><br><span class="line">3: 0x0000000041800000..0x00000000420fffff, size:9216K</span><br><span class="line">4: 0x0000000045000000..0x00000000467fffff, size:24576K</span><br><span class="line">5: 0x0000000046d86000..0x0000000046f85fff, size:2048K</span><br><span class="line">6: 0x0000000047f29e00..0x0000000047f59e5f, size:192K</span><br><span class="line">7: 0x0000000047f59e80..0x0000000047f59edf, size:0K</span><br><span class="line">8: 0x0000000047f59f00..0x0000000047f8400f, size:168K</span><br><span class="line">9: 0x0000000047f84080..0x0000000047f84087, size:0K</span><br><span class="line">10: 0x0000000047f84100..0x0000000047f84107, size:0K</span><br><span class="line">11: 0x0000000047f85180..0x0000000047fff2e6, size:488K</span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure>
<p>在内核 cmdline 加上 memblock=debug bootmem_debug=1 参数，在内核启动时，会打印上述 reserved memory 详细信息。由于内容太多，这里不展示了。</p>
<p>经分析对比，当前 R329 reserved memory 主要包含如下几个部分：</p>
<ul>
<li><p>0: 0x0000000040080000..0x00000000408a3fff, size:8336K<br>  内核代码段、数据段。详细包括 text， init， data， bss 四段，其中 init 在内核启动完成后会被释放。</p>
</li>
<li><p>1: 0x00000000408a5000..0x00000000408a5fff, size:4K<br>  略</p>
</li>
<li><p>2: 0x0000000041700000..0x000000004171767f, size:93K<br>  DTB 占用内存</p>
</li>
<li><p>3: 0x0000000041800000..0x00000000420fffff, size:9216K<br>  TEE 内存（共 8M，包括 SHM 2M， ATF 1M， OS 1M， TA 4M）。DSP 内存（共 1M）。</p>
</li>
<li><p>4: 0x0000000045000000..0x00000000467fffff, size:24576K<br>  CMA 内存，共 24M，在 cmdline 中通过 cma=24M 配置而来。在初始化的过程中， CMA 内存会全部导入伙伴系统（具体是通过 cma_init_reserved_areas 函数来实现），所以内核是可以支配 CMA 内存的</p>
</li>
<li><p>5: 0x0000000046d86000..0x0000000046f85fff, size:2048K<br>  所有 struct page 结构体的总大小。 struct page 结构体用来描述物理上的页帧。当前 R329 上配置一个页的大小为 4K，因此总共有 128M / 4K = 32768 个页，而 sizeof(struct page) 的值为 64B，因此这一块共 32768 * 64 = 2048 KB。注： aarch64 内核 sizeof(struct page) 的值为 64B， arm32 内核 sizeof(struct page) 的值为 32B。</p>
</li>
<li><p>6: 0x0000000047f29e00..0x0000000047f59e5f, size:192K<br>  主要是 vfs cache，包括 Dentry 和 Inode 的 hash table，存放最近访问的 Dentry 和 Inode 节点，加速对虚拟文件系统的访问。</p>
</li>
<li><p>8: 0x0000000047f59f00..0x0000000047f8400f, size:168K<br>  主要是 per-cpu 变量占用的内存。</p>
</li>
<li><p>11: 0x0000000047f85180..0x0000000047fff2e6, size:488K<br>  主要是解析 dtb 生成 struct device_node 结构体所用的内存。</p>
</li>
</ul>
<h2 id="buffers-amp-cached"><a href="#buffers-amp-cached" class="headerlink" title="buffers &amp; cached"></a>buffers &amp; cached</h2><p>free 命令第二行为什么要-/+ buffers/cache？ buffers 与 cached 内存都属于空闲内存么？</p>
<p>Linux 为加速 IO 访问速度，会使用空闲内存来缓存文件以及元数据等内容，这就是 buffers 和 cached 内存。当内存不足时，这些内存会被回收，供内核与应用使用。所以 buffer 与 cache 实际上是已经使用了的内存，由于可以回收，属于潜在的空闲内存。但是并非所有的 buffer 和 cache 都可以回收，比如：</p>
<ul>
<li>如果有某个进程访问块设备或者普通文件，就需要 buffers 和 cached 空间，这部分就不能释放。</li>
<li>shared、 tmpfs 也包含在 cached 空间中。</li>
</ul>
<h2 id="系统使用的内存"><a href="#系统使用的内存" class="headerlink" title="系统使用的内存"></a>系统使用的内存</h2><p>free 命令的结果展示系统已经使用了 47928KB 的内存，都用到哪里去了呢？</p>
<h3 id="进程使用的内存"><a href="#进程使用的内存" class="headerlink" title="进程使用的内存"></a>进程使用的内存</h3><p>新增一个进程使用了哪些内存？<br>首先，访问文件系统加载进程的可执行文件、库等，导致 buffer/cache 增大；其次，进程本身在用户空间运行时需要有自己的地址空间信息（用 mm_struct 结构体来表示，包含代码段、数据段、用户栈等地址空间描述）；再次，内核会为进程创建进程描述符（task_struct）、内存描述符（mm_struct）等结构体，用于管理进程；此外，进程还有对应的内核栈，当进程陷入内核时需要内核栈来支持内核函数调用等等。<br>我们常说的进程使用的内存，指的是在用户空间所使用的内存。<br>关于用户进程的内存使用，涉及几个通用概念：</p>
<ul>
<li>VSS： Virtual Set Size 使用的虚拟内存（包含共享库占用的内存）</li>
<li>RSS： Resident Set Size 实际使用物理内存（包含共享库占用的内存）</li>
<li>PSS： Proportional Set Size 实际使用的物理内存（比例分配共享库占用的内存）</li>
<li>USS： Unique Set Size 进程独自占用的物理内存（不包含共享库占用的内存）</li>
</ul>
<p>一般来说： VSS &gt;= RSS &gt;= PSS &gt;= USS</p>
<p>在/proc/<pid>/smaps 节点中包含了进程的每一个内存映射的统计值，包含了 PSS、 RSS 等信息。<br>所以对/proc/<pid>/smaps 节点中所有的 PSS 进行累加，即可统计出所有进程在用户空间所使用的内存，具体命令如下：</pid></pid></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep ^Pss /proc/[0-9]*/smaps | awk <span class="string">'{total+=$2}; END {print total}'</span></span><br></pre></td></tr></tbody></table></figure>
<p>查看 rss 信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/`pidof ***app`/status | grep RSS</span><br></pre></td></tr></tbody></table></figure>
<p>此外还有 ramparser 统计工具：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Tina:/proc/684<span class="comment">#  ramparser -a | grep Total</span></span><br><span class="line">Mem      Total = 256 Mb   (Free 7.39 Mb, Available 7.75 Mb)</span><br><span class="line">Mem Used Total = 235.96 Mb</span><br><span class="line">Mem Used Total = Kernel used total(21.21Mb) + pss total(100.72Mb) +</span><br></pre></td></tr></tbody></table></figure>
<h3 id="总使用内存"><a href="#总使用内存" class="headerlink" title="总使用内存"></a>总使用内存</h3><p>单一个进程，涉及到了很多种类的内存使用，完全统计起来不太现实。为统计系统总使用内存，可将其划分为用户空间使用内存与内核使用内存。<br>用户空间使用的内存 = Buffers + Cached + AnonPages。<br>内核使用的内存 = Slab + PageTable + KernelStack + CmaUsed + Vmalloc + X。</p>
<p>其中，</p>
<ul>
<li>CmaUsed = CmaTotal - CmaFree。</li>
<li>Vmalloc 表示/proc/vmallocinfo 中的 vmalloc 分配的内存，包含了内核模块使用的内存。计算方法为 grep vmalloc /proc/vmallocinfo | awk ‘{total+=$2}; END {print total}’。</li>
<li>X 表示直接通过 alloc_pages/get_free_page 分配的内存，这部分内存未纳入统计，属于内存黑洞。</li>
</ul>
<h1 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h1><p>主要包括：</p>
<ul>
<li>保留内存优化</li>
<li>内核使用内存优化</li>
<li>用户空间使用内存优化</li>
</ul>
<h2 id="保留内存优化"><a href="#保留内存优化" class="headerlink" title="保留内存优化"></a>保留内存优化</h2><h3 id="内核静态内存优化"><a href="#内核静态内存优化" class="headerlink" title="内核静态内存优化"></a>内核静态内存优化</h3><p>内核静态内存包括内核代码段数据段。优化方法主要有如下几种：<br>关闭不需要的模块，关闭模块下不需要的功能</p>
<ul>
<li><p>在内核根目录，执行。/scripts/ksize vmlinux 各个模块的代码段数据段的统计信息：</p>
  <figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">Linux Kernel (vmlinux)                                      total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">vmlinux                                                   6471329 |    4315221    2013884     142224</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">drivers                                                   2899612 |    2032098     819710      47804</span><br><span class="line">net                                                        753530 |     721792      23658       8080</span><br><span class="line">fs                                                         664960 |     642997       3151      18812</span><br><span class="line">kernel                                                     543470 |     467211      34187      42072</span><br><span class="line">mm                                                         314765 |     288517       6932      19316</span><br><span class="line">crypto                                                     254117 |     196774      57271         72</span><br><span class="line">sound                                                      193477 |     188029       3852       1596</span><br><span class="line">lib                                                        156575 |     154010        236       2329</span><br><span class="line">block                                                      151072 |     147441       2399       1232</span><br><span class="line">ipc                                                         30522 |      29794        724          4</span><br><span class="line">init                                                        25199 |      10990      14145         64</span><br><span class="line">security                                                     4780 |       4756          8         16</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                       5992079 |    4884409     966273     141397</span><br><span class="line">delta                                                      479250 |    -569188    1047611        827</span><br><span class="line"></span><br><span class="line">drivers                                                     total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">drivers/built-in.o                                        2899612 |    2032098     819710      47804</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">drivers/video                                             1012684 |     244524     739328      28832</span><br><span class="line">drivers/usb                                                247516 |     235586       8306       3624</span><br><span class="line">drivers/mtd                                                180132 |     171969       5455       2708</span><br><span class="line">drivers/media                                              171917 |     167120       3313       1484</span><br><span class="line">drivers/base                                               168782 |     164886       3264        632</span><br><span class="line">drivers/mmc                                                150962 |     149050       1716        196</span><br><span class="line">drivers/tty                                                 92952 |      89978       1070       1904</span><br><span class="line">drivers/clk                                                 71921 |      55673      15584        664</span><br><span class="line">drivers/hid                                                 69921 |      66181       3728         12</span><br><span class="line">drivers/regulator                                           60558 |      58806       1612        140</span><br><span class="line">drivers/char                                                59195 |      54555       3640       1000</span><br><span class="line">drivers/input                                               57220 |      54728       2348        144</span><br><span class="line">drivers/pinctrl                                             56336 |      49295       6957         84</span><br><span class="line">drivers/spi                                                 46753 |      45264       1485          4</span><br><span class="line">drivers/cpufreq                                             46675 |      41339       1088       4248</span><br><span class="line">drivers/i2c                                                 46201 |      45552        597         52</span><br><span class="line">drivers/of                                                  36229 |      35370        371        488</span><br><span class="line">drivers/thermal                                             30927 |      28822       2029         76</span><br><span class="line">drivers/gpio                                                30829 |      30392        404         33</span><br><span class="line">drivers/staging                                             27577 |      27104        449         24</span><br><span class="line">drivers/power                                               24587 |      22547       1708        332</span><br><span class="line">drivers/iommu                                               23637 |      23029        544         64</span><br><span class="line">drivers/rtc                                                 21690 |      21150        384        156</span><br><span class="line">drivers/mfd                                                 21408 |      14180       7220          8</span><br><span class="line">drivers/iio                                                 18761 |      18545        160         56</span><br><span class="line">drivers/dma                                                 18404 |      17998        310         96</span><br><span class="line">drivers/pwm                                                 17398 |      16766        456        176</span><br><span class="line">drivers/irqchip                                             15919 |      13483       2340         96</span><br><span class="line">drivers/dma-buf                                             14119 |      14064         23         32</span><br><span class="line">drivers/soc                                                 12843 |      11375       1332        136</span><br><span class="line">drivers/watchdog                                            10668 |      10174        449         45</span><br><span class="line">drivers/clocksource                                          9076 |       8380        592        104</span><br><span class="line">drivers/bus                                                  6536 |       5762        738         36</span><br><span class="line">drivers/hwmon                                                5226 |       5054        144         28</span><br><span class="line">drivers/misc                                                 4730 |       4358        360         12</span><br><span class="line">drivers/reset                                                3838 |       3718        120          0</span><br><span class="line">drivers/firmware                                             3587 |       3527          4         56</span><br><span class="line">drivers/net                                                  1479 |       1431         48          0</span><br><span class="line">drivers/mpp                                                   350 |        334          8          8</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                       2899543 |    2032069     819684      47790</span><br><span class="line">delta                                                          69 |         29         26         14</span><br><span class="line"></span><br><span class="line">net                                                         total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">net/built-in.o                                             753530 |     721792      23658       8080</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">net/ipv4                                                   343777 |     327407      12726       3644</span><br><span class="line">net/core                                                   231660 |     222656       7276       1728</span><br><span class="line">net/xfrm                                                    50407 |      48727       1292        388</span><br><span class="line">net/unix                                                    27015 |      24614        344       2057</span><br><span class="line">net/packet                                                  26639 |      26370        269          0</span><br><span class="line">net/netlink                                                 25701 |      25138        423        140</span><br><span class="line">net/key                                                     20676 |      20372        300          4</span><br><span class="line">net/*.o                                                     15735 |      15307        376         52</span><br><span class="line">net/sched                                                    8093 |       7528        565          0</span><br><span class="line">net/ethernet                                                 2443 |       2403         40          0</span><br><span class="line">net/ipv6                                                     1263 |       1227         28          8</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        753409 |     721749      23639       8021</span><br><span class="line">delta                                                         121 |         43         19         59</span><br><span class="line"></span><br><span class="line">fs                                                          total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">fs/built-in.o                                              664960 |     642997       3151      18812</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">fs/*.o                                                     351463 |     339657       1550      10256</span><br><span class="line">fs/proc                                                     83517 |      78968        361       4188</span><br><span class="line">fs/jffs2                                                    79570 |      79278        136        156</span><br><span class="line">fs/fat                                                      51402 |      51230        144         28</span><br><span class="line">fs/kernfs                                                   21130 |      16955         75       4100</span><br><span class="line">fs/configfs                                                 19069 |      18820        237         12</span><br><span class="line">fs/squashfs                                                 19013 |      18965         44          4</span><br><span class="line">fs/debugfs                                                  15752 |      15688         52         12</span><br><span class="line">fs/nls                                                      11112 |      10996        116          0</span><br><span class="line">fs/sysfs                                                     7133 |       7086         39          8</span><br><span class="line">fs/devpts                                                    3299 |       2938        353          8</span><br><span class="line">fs/ramfs                                                     1840 |       1796         40          4</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        664300 |     642377       3147      18776</span><br><span class="line">delta                                                         660 |        620          4         36</span><br><span class="line"></span><br><span class="line">kernel                                                      total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">kernel/built-in.o                                          543470 |     467211      34187      42072</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">kernel/*.o                                                 228463 |     209842      11969       6652</span><br><span class="line">kernel/time                                                 94112 |      83229       6691       4192</span><br><span class="line">kernel/printk                                               54979 |      18467       8424      28088</span><br><span class="line">kernel/sched                                                47388 |      43798       3446        144</span><br><span class="line">kernel/irq                                                  43205 |      40313        812       2080</span><br><span class="line">kernel/rcu                                                  31236 |      29275       1932         29</span><br><span class="line">kernel/power                                                18951 |      17575        828        548</span><br><span class="line">kernel/locking                                              16625 |      16616          5          4</span><br><span class="line">kernel/bpf                                                   8404 |       8048         64        292</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        543363 |     467163      34171      42029</span><br><span class="line">delta                                                         107 |         48         16         43</span><br><span class="line"></span><br><span class="line">sound                                                       total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">sound/built-in.o                                           193477 |     188029       3852       1596</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">sound/soc                                                  101278 |      98458       2688        132</span><br><span class="line">sound/core                                                  91802 |      89198       1148       1456</span><br><span class="line">sound/*.o                                                     586 |        558         20          8</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        193666 |     188214       3856       1596</span><br><span class="line">delta                                                        -189 |       -185         -4          0</span><br><span class="line"></span><br><span class="line">lib                                                         total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">lib/built-in.o                                             156575 |     154010        236       2329</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">lib/*.o                                                    192773 |     192059        644         70</span><br><span class="line">lib/zlib_deflate                                            16704 |      14364         60       2280</span><br><span class="line">lib/zlib_inflate                                            11187 |      11187          0          0</span><br><span class="line">lib/xz                                                       8199 |       8163         36          0</span><br><span class="line">lib/lzo                                                      2551 |       2551          0          0</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        231414 |     228324        740       2350</span><br><span class="line">delta                                                      -74839 |     -74314       -504        -21</span><br><span class="line"></span><br><span class="line">block                                                       total |       text       data        bss</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">block/built-in.o                                           151072 |     147441       2399       1232</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">block/*.o                                                  143829 |     140218       2383       1228</span><br><span class="line">block/partitions                                             7227 |       7207         16          4</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="built_in">sum</span>                                                        151056 |     147425       2399       1232</span><br><span class="line">delta                                                          16 |         16          0          0</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>关闭内核调试功能</p>
</li>
<li>开启 CONFIG_CC_OPTIMIZE_FOR_SIZE 宏，使能-Os 编译参数</li>
<li>排查内核占用空间大的符号</li>
</ul>
<p>执行 nm —size -r vmlinux，可以列出所有符号占用的内存</p>
<ul>
<li>开启 CONFIG_THUMB2_AVOID_R_ARM_THM_JUMP11 和 CONFIG_THUMB2_KERNEL。注：会带来性能损失，具体损失根据实际平台典型应用场景进行测试</li>
</ul>
<h3 id="DTB-内存优化"><a href="#DTB-内存优化" class="headerlink" title="DTB 内存优化"></a>DTB 内存优化</h3><p>Tina 内核中提供的 DTS 一般来说比较全面，对于特定的方案，往往用不了那么多，可以针对性的删除一些节点。</p>
<h3 id="TEE-内存优化"><a href="#TEE-内存优化" class="headerlink" title="TEE 内存优化"></a>TEE 内存优化</h3><p>Tina 中一些平台，会默认配置一些 TEE 保留内存。对于特定方案来说，很有可能用不了那么多内存。 TEE 默认保留配置与 bl31.bin、 optee-${CHIP}.bin 是配套的，因此修改时需要注意步更新。<br>比如 R329 默认配置了 8M 内存（SHM 2M,ATF 1M,OS 1M,TA 4M），但是对于非安全方案来说，只需要保留 ATF 就够了；对于不使用 TA 的安全方案，只需要保留 ATF 与 OS 的内存就可以了。</p>
<h2 id="内核使用内存优化"><a href="#内核使用内存优化" class="headerlink" title="内核使用内存优化"></a>内核使用内存优化</h2><p>内核使用的内存包括 Slab、 PageTable、 KernelStack、 CmaUsed、Vmalloc 等</p>
<h2 id="Slab-优化"><a href="#Slab-优化" class="headerlink" title="Slab 优化"></a>Slab 优化</h2><p>目前 Tina 上大部分方案默认选用的是 SLUB 分配器</p>
<ul>
<li>关闭 slab 调试宏 COFNIG_SLUB_DEBUG 与 CONFIG_SLABINFO</li>
<li>尝试使用针对微小的嵌入式系统的 SLOB</li>
</ul>
<h2 id="内核模块优化"><a href="#内核模块优化" class="headerlink" title="内核模块优化"></a>内核模块优化</h2><ul>
<li>不要开机全部加载，实时加载，实时卸载</li>
<li>将内核模块编译到内核镜像中</li>
</ul>
<h2 id="用户空间使用内存优化"><a href="#用户空间使用内存优化" class="headerlink" title="用户空间使用内存优化"></a>用户空间使用内存优化</h2><ul>
<li>使用更小的 C 库</li>
<li>使用 size 优化的编译选项，比如-Os， -mthumb 等</li>
<li>将 tmpfs 下大文件保持到 flash 上</li>
<li>对于 64 位 CPU，可以使用 32 位的 rootfs</li>
<li>使用更小的库或应用程序。比如使用 mbedtls，而不是 openssl</li>
<li>减少守护进程数量，实时运行/关闭特定程序</li>
<li>将只被一次依赖的动态库转化为动态库；使用 dlopen 来控制动态库的生存周期</li>
<li>优化程序源码</li>
</ul>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>《全志SDK文档》   </p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Programming/">Programming</a><a class="post-meta__tags" href="/tags/Debug/">Debug</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Performance/">Performance</a></div><div class="post_share"><div class="social-share" data-image="https://unsplash.it/1600/900?random&amp;2923" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/Debug/LinuxSystemCropping/" title="Linux 系统裁剪"><img class="cover" src="https://unsplash.it/1600/900?random&amp;2057" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux 系统裁剪</div></div></a></div><div class="next-post pull-right"><a href="/Debug/LinuxPerf/" title="Linux 性能分析"><img class="cover" src="https://unsplash.it/1600/900?random&amp;3236" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux 性能分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/Debug/LinuxPerf/" title="Linux 性能分析"><img class="cover" src="https://unsplash.it/1600/900?random&3236" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-03-01</div><div class="title">Linux 性能分析</div></div></a></div><div><a href="/Debug/LinuxSystemCropping/" title="Linux 系统裁剪"><img class="cover" src="https://unsplash.it/1600/900?random&2057" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-03-09</div><div class="title">Linux 系统裁剪</div></div></a></div><div><a href="/Debug/LinuxSystemStartOptimization/" title="Linux 启动优化"><img class="cover" src="https://unsplash.it/1600/900?random&860" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-03-19</div><div class="title">Linux 启动优化</div></div></a></div><div><a href="/Debug/ApplicationDebug/" title="应用崩溃调试分析"><img class="cover" src="https://unsplash.it/1600/900?random&6742" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-26</div><div class="title">应用崩溃调试分析</div></div></a></div><div><a href="/Debug/CCMemLeakAsync/" title="C&#x2F;C++内存泄露分析过程"><img class="cover" src="https://unsplash.it/1600/900?random&2911" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-21</div><div class="title">C&#x2F;C++内存泄露分析过程</div></div></a></div><div><a href="/Debug/LinuxCpuIdle/" title="CPUIdle"><img class="cover" src="https://unsplash.it/1600/900?random&7209" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-30</div><div class="title">CPUIdle</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CarlyleLiu</div><div class="author-info__description">CarlyleLiu’s Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">194</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/carlyleliu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/carlyleliu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yyliushuai@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-envelope" style="color: #24292e;"></i></a><a class="social-icon" href="https://twitter.com/yyliushuai" target="_blank" title="Twitter"><i class="fab fa-twitter" style="color: #24292e;"></i></a><a class="social-icon" href="https://youtube.com/carlyleliu" target="_blank" title="YouTube"><i class="fab fa-youtube" style="color: #24292e;"></i></a><a class="social-icon" href="https://instagram.com/blurredliu" target="_blank" title="Instagram"><i class="fab fa-instagram" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">next主题站 https://carlyleliu.github.io/next</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">内存使用情况分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DRAM-%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.1.</span> <span class="toc-text">DRAM 大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">1.2.</span> <span class="toc-text">系统内存使用情况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#free-%E5%91%BD%E4%BB%A4"><span class="toc-number">1.2.1.</span> <span class="toc-text">free 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%A1%8C-Mem%EF%BC%8C%E5%BD%93%E5%89%8D%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">第一行 Mem，当前系统内存的使用情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%A1%8C"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">第二行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%A1%8C-Swap%EF%BC%8C%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">第三行 Swap，交换分区的使用情况</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proc-meminfo-%E8%8A%82%E7%82%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">&#x2F;proc&#x2F;meminfo 节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E5%86%85%E5%AD%98"><span class="toc-number">1.3.</span> <span class="toc-text">保留内存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#buffers-amp-cached"><span class="toc-number">1.4.</span> <span class="toc-text">buffers &amp; cached</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E7%9A%84%E5%86%85%E5%AD%98"><span class="toc-number">1.5.</span> <span class="toc-text">系统使用的内存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8%E7%9A%84%E5%86%85%E5%AD%98"><span class="toc-number">1.5.1.</span> <span class="toc-text">进程使用的内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98"><span class="toc-number">1.5.2.</span> <span class="toc-text">总使用内存</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">内存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E7%95%99%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.</span> <span class="toc-text">保留内存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%9D%99%E6%80%81%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.1.</span> <span class="toc-text">内核静态内存优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DTB-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.2.</span> <span class="toc-text">DTB 内存优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TEE-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.1.3.</span> <span class="toc-text">TEE 内存优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.2.</span> <span class="toc-text">内核使用内存优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Slab-%E4%BC%98%E5%8C%96"><span class="toc-number">2.3.</span> <span class="toc-text">Slab 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E4%BC%98%E5%8C%96"><span class="toc-number">2.4.</span> <span class="toc-text">内核模块优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">2.5.</span> <span class="toc-text">用户空间使用内存优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">3.</span> <span class="toc-text">参考文献</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2025 By CarlyleLiu</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>