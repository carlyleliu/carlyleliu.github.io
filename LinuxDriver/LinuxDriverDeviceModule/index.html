<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="5txRYykRNG5Z1NrO_ZCLF1GZWnbFmCOLdJHGBVFuCIg">
  <meta name="baidu-site-verification" content="code-XfgDErPTZS">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reddit+Mono:300,300italic,400,400italic,700,700italic%7CNoto+Sans:300,300italic,400,400italic,700,700italic%7COpen+Sans:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/black/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"carlyleliu.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":true,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"hide","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="kobject  概述  Kobjects 有一个 name 和一个引用计数，还具有父指针（允许将对象排列成层次结构） ktype 是嵌入在 kobject 结构体中的对象。 每个 kobject 结构都需要一个相应的 ktype。 ktype 控制 kobject 在创建和销毁时的行为 kset 是一组 kobjects(kset 本身包含一个 kobject), 这些 kobject 可以拥">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux 驱动之设备驱动模型">
<meta property="og:url" content="https://carlyleliu.github.io/LinuxDriver/LinuxDriverDeviceModule/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="kobject  概述  Kobjects 有一个 name 和一个引用计数，还具有父指针（允许将对象排列成层次结构） ktype 是嵌入在 kobject 结构体中的对象。 每个 kobject 结构都需要一个相应的 ktype。 ktype 控制 kobject 在创建和销毁时的行为 kset 是一组 kobjects(kset 本身包含一个 kobject), 这些 kobject 可以拥">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/Kobject_Struct.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/Kobject_List.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/BusStruct.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/BusList.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/DeviceRegister.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/DriverRegister.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/uevent.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/PlatformStruct.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/PlatformStruct.png">
<meta property="article:published_time" content="2020-08-07T06:52:33.000Z">
<meta property="article:modified_time" content="2025-04-12T10:29:22.000Z">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Driver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/Kobject_Struct.png">


<link rel="canonical" href="https://carlyleliu.github.io/LinuxDriver/LinuxDriverDeviceModule/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://carlyleliu.github.io/LinuxDriver/LinuxDriverDeviceModule/","path":"LinuxDriver/LinuxDriverDeviceModule/","title":"Linux 驱动之设备驱动模型"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux 驱动之设备驱动模型 | Matrix</title>
  







<link rel="dns-prefetch" href="https://waline.carlyleliu.vip">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Matrix</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CarlyleLiu‘s Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-alist"><span class="exturl" data-url="aHR0cHM6Ly9hbGlzdC5jYXJseWxlbGl1LnZpcC8="><i class="fa-solid fa-cloud fa-fw"></i>网盘</span></li><li class="menu-item menu-item-books"><span class="exturl" data-url="aHR0cHM6Ly9jYWxpYnJlLmNhcmx5bGVsaXUudmlwLw=="><i class="fa-solid fa-book fa-fw"></i>书库</span></li><li class="menu-item menu-item-talk"><span class="exturl" data-url="aHR0cHM6Ly9tZW1vcy5jYXJseWxlbGl1LnZpcC9leHBsb3JlLw=="><i class="fas fa-comments fa-fw"></i>随笔</span></li><li class="menu-item menu-item-album"><span class="exturl" data-url="aHR0cHM6Ly9pbW1pY2guY2FybHlsZWxpdS52aXAvc2hhcmUvSmtSenVqZERfdWVJRnJRNHpvYnpfUW1EVndRZkdGS3ZyVTh0ZlJIYWN1ZG9ZMjV0Z2tFdDd6aS1Wck5oYUEzZUdpNC8="><i class="fa-solid fa-image fa-fw"></i>相册</span></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kobject"><span class="nav-text"> kobject</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-text"> 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kobject-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%AE%9E%E7%8E%B0"><span class="nav-text"> kobject 的数据结构和实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%B3%95api"><span class="nav-text"> 用法（API）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#example"><span class="nav-text"> example</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#bus-device-%E5%92%8C-driver"><span class="nav-text"> bus、device 和 driver</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text"> 数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-text"> 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#device-%E7%9A%84%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-text"> device 的注册过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#driver-%E7%9A%84%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-text"> driver 的注册过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bus-%E7%9A%84%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-text"> bus 的注册过程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#class"><span class="nav-text"> class</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#uevent"><span class="nav-text"> Uevent</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="nav-text"> 实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#platfor-%E6%80%BB%E7%BA%BF"><span class="nav-text"> platfor 总线</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#platform-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text"> platform 数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#platform-%E6%80%BB%E7%BA%BF%E5%AE%9E%E7%8E%B0"><span class="nav-text"> platform 总线实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text"> 总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text"> 参考文献</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CarlyleLiu</p>
  <div class="site-description" itemprop="description">CarlyleLiu’s Blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">212</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nhcmx5bGVsaXU=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;carlyleliu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnl5bGl1c2h1YWlAZ21haWwuY29t" title="E-Mail → mailto:yyliushuai@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95eWxpdXNodWFp" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;yyliushuai"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbS9jYXJseWxlbGl1" title="YouTube → https:&#x2F;&#x2F;youtube.com&#x2F;carlyleliu"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbnN0YWdyYW0uY29tL2JsdXJyZWRsaXU=" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;blurredliu"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://carlyleliu.github.io/LinuxDriver/LinuxDriverDeviceModule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CarlyleLiu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
      <meta itemprop="description" content="CarlyleLiu’s Blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux 驱动之设备驱动模型 | Matrix">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux 驱动之设备驱动模型
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology-Blog/" itemprop="url" rel="index"><span itemprop="name">Technology Blog</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology-Blog/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology-Blog/Linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/LinuxDriver/LinuxDriverDeviceModule/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/LinuxDriver/LinuxDriverDeviceModule/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="kobject"><a class="markdownIt-Anchor" href="#kobject"></a> kobject</h1>
<h2 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h2>
<ul>
<li>Kobjects 有一个 name 和一个引用计数，还具有父指针（允许将对象排列成层次结构）</li>
<li>ktype 是嵌入在 kobject 结构体中的对象。 每个 kobject 结构都需要一个相应的 ktype。 ktype 控制 kobject 在创建和销毁时的行为</li>
<li>kset 是一组 kobjects(kset 本身包含一个 kobject), 这些 kobject 可以拥有相同的 ktype，kset 也是 sysfs 中的一个子目录。Ksets 可以支持 kobjects 的“热插拔”（uevent 事件）</li>
</ul>
<span id="more"></span>
<h2 id="kobject-的数据结构和实现"><a class="markdownIt-Anchor" href="#kobject-的数据结构和实现"></a> kobject 的数据结构和实现</h2>
<p>下图展示了 kobject、ktype 和 kset 三者数据结构之间的关系：<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWE2ZmU3ZDljMDg2NjUxM2U5ZDA4">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/Kobject_Struct.png" alt=""></p>
<ul>
<li>
<p>sysfs_ops:<br>
show 是回调函数，在读取具有该 kobj_type 的所有属性时调用他。缓冲区长度始终是 PAGE_SIZE，在成功时返回写入缓冲区的数据大小，失败返回错误码。写入的时候调用 store 函数，其参数 buf 最大为 PAGE_SIZE，成功返回写入数据大小，失败返回错误码</p>
</li>
<li>
<p>uevent_ops:<br>
是此 kset 的 uevent 操作集</p>
</li>
<li>
<p>attribute:<br>
是由 kobject 导出到用户空间 sysfs 文件，attribute 表示可以从用户空间读取、写入或同时具有这两者的对象属性，属性将内核数据映射到 sysfs 中的文件</p>
</li>
</ul>
<p>用于从文件系统添加/删除属性的函数如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __must_check <span class="title function_">sysfs_create_file</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">						 <span class="type">const</span> <span class="keyword">struct</span> attribute *attr)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sysfs_remove_file</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">				     <span class="type">const</span> <span class="keyword">struct</span> attribute *attr)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>除此之外还有一个数据结构 attribute_group 很常用：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> {</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*name;</span><br><span class="line">	<span class="type">umode_t</span>			(*is_visible)(<span class="keyword">struct</span> kobject *,</span><br><span class="line">					      <span class="keyword">struct</span> attribute *, <span class="type">int</span>);</span><br><span class="line">	<span class="type">umode_t</span>			(*is_bin_visible)(<span class="keyword">struct</span> kobject *,</span><br><span class="line">						  <span class="keyword">struct</span> bin_attribute *, <span class="type">int</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">attribute</span>	**<span class="title">attrs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bin_attribute</span>	**<span class="title">bin_attrs</span>;</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>attrs 字段是一个指针，他指向以 NULL 结尾的属性列表，每个属性组必须赋予一个指向 struct attribute 元素列表/数组的指针，该 group 只是一个 helper 包装器，以便管理多个属性。<br>
在实际使用中可以定义多个属性文件然后嵌入在 struct attribute_group 结构体中，之后调用如下函数可以一次将多个属性添加/删除到系统。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __must_check <span class="title function_">sysfs_create_group</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">				                    <span class="type">const</span> <span class="keyword">struct</span> attribute_group *grp)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">sysfs_remove_group</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span><br><span class="line"><span class="params">			            <span class="type">const</span> <span class="keyword">struct</span> attribute_group *grp)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>下图展示了 kset 和 kobject 通常的组织关系，形成层级关系，当其他结构需要构建层级关系或需要引用计数的时候都可以将这个数据结构嵌入进去：<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWE3NTIxZWZhZDQxZDgyNWM3Zjc5">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/Kobject_List.png" alt=""></p>
<h2 id="用法api"><a class="markdownIt-Anchor" href="#用法api"></a> 用法（API）</h2>
<ol>
<li>创建 kobjec 的代码必须初始化该对象：</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kobject_init</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype)</span>;</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>正确创建 kobject 需要 ktype，因为每个 kobject 都必须有一个关联的 kobj_type。 调用 kobject_init() 后，要向 sysfs 注册 kobject，必须调用函数 kobject_add()：</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_add</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobject *parent, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>如果 kobject 要与特定的 kset 相关联，kobj-&gt;kset 必须在调用 kobject_add() 之前赋值。 如果 kset 是与 kobject 相关联的，那么 kobject 的父级可以在调用 kobject_add() 时设置为 NULL，然后 kobject 的父级将是 kset 本身。</p>
<ol start="3">
<li>由于 kobject 的名称是在添加到内核时设置的，因此不应直接操作 kobject 的名称。 如果必须更改 kobject 的名称，请调用 kobject_rename()：</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_rename</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="type">const</span> <span class="type">char</span> *new_name)</span>;</span><br></pre></td></tr></tbody></table></figure>
<ol start="4">
<li>有一个辅助函数可以初始化 kobject 并将其添加到内核同时调用 kobject_init_and_add()：</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_init_and_add</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype,</span></span><br><span class="line"><span class="params">                        <span class="keyword">struct</span> kobject *parent, <span class="type">const</span> <span class="type">char</span> *fmt, ...)</span>;</span><br></pre></td></tr></tbody></table></figure>
<ol start="5">
<li>在 kobject 注册到 kobject 核心后，您需要通知它已被创造。 这可以通过调用 kobject_uevent() 来完成：</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_uevent</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">enum</span> kobject_action action)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>当 kobject 从内核中删除时， KOBJ_REMOVE 的 uevent 将由 kobject 核心自动调用，因此调用者不必担心手动执行此操作。</p>
<ol start="6">
<li>kobject 的关键功能之一是用作嵌入它的对象的引用计数器，用于操作 kobject 引用计数的函数是：</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> kobject *<span class="title function_">kobject_get</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kobject_put</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>当引用被释放时，对 kobject_put() 的调用将减少引用计数，并可能释放对象。</p>
<ol start="7">
<li>每个注册的 kset 对应 sysfs 目录，可以使用 kset_create_and_add() 函数创建和添加 kset，使用 kset_unregister() 函数将其删除</li>
</ol>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kset * __must_check <span class="title function_">kset_create_and_add</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">						<span class="type">const</span> <span class="keyword">struct</span> kset_uevent_ops *u,</span></span><br><span class="line"><span class="params">						<span class="keyword">struct</span> kobject *parent_kobj)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">kset_unregister</span><span class="params">(<span class="keyword">struct</span> kset *kset)</span></span><br></pre></td></tr></tbody></table></figure>
<p>因为 kobject 是动态的，所以它们不能静态声明或在堆栈上声明，而是始终动态分配。 内核的未来版本将包含对静态创建的 kobjects 的运行时检查，并将警告开发人员这种不正确的使用。</p>
<h2 id="example"><a class="markdownIt-Anchor" href="#example"></a> example</h2>
<p>参考 samples/kobject/kobject-example.c</p>
<h1 id="bus-device-和-driver"><a class="markdownIt-Anchor" href="#bus-device-和-driver"></a> bus、device 和 driver</h1>
<h2 id="数据结构"><a class="markdownIt-Anchor" href="#数据结构"></a> 数据结构</h2>
<p>要理解 linux 驱动的设计，首先要理清楚 linux 驱动最重要的几个数据结构，struct device, struct device_driver, struct bus 这些数据结构是理解 Linux 驱动的关键，下面先从整体上看一下这几个数据结构之间的关系，如下：<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWE3YTFlNDAxZmQzYzI0OWRjZmVj">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/BusStruct.png" alt=""></p>
<ul>
<li>
<p>bus:<br>
bus 结构体用于抽象系统中总线的数据结构，这个可以是实际的总线，例如 iic、spi 总线，也可以是虚拟总线 platform 总线。struct bus 结构体管理挂载在该 bus 下的 struct device 和 struct device_driver, 负责 device 和 device_driver 的匹配，调用 probe 等工作。其中管理 struct device 和 struct device_driver 的功能独立出来成为一个子系统叫 subsys_private，该数据结构除了管理该 bus 下的设备和驱动外还用于处理 bus，device 和 device_driver 的一些默认属性（公共属性），uevent 事件等。可以看到 subsys_private 数据结构下有两个链表一个用于挂载 device 另一个用于挂载 device_driver, 从而实现 bus 对 device 和 device_driver 管理</p>
</li>
<li>
<p>device:<br>
device 结构体用于抽象驱动设备，系统下挂载的设备都是通过 struct device 结构体来描述，其中 dts 里定义的很多节点都会转换为 struct device 结构体，用于描述一个设备信息，管理设备用到的资源等。device 结构体下一个重要结构是 device_private，该结构体成员 knode_bus 就是用于挂载到上面提到的 bus 下的 subsys_private 结构体中的 klist_devices</p>
</li>
<li>
<p>device_driver:<br>
device_driver 结构体用于描述对 struct device 结构体描述的设备的驱动方法，比如对于通信协议的实现，对控制器的操作等。这样设备和设备的驱动实现分离单独管理，而设备和驱动分离后两者的匹配工作就是 bus 完成的，device_driver 是用户需要编写的具体操作设备的方法和流程。同样 struct device_driver 结构体下的 driver_private 的 knode_bus 用于链接到 struct bus 下 subsys_private 结构体中的 klist_drivers</p>
</li>
</ul>
<p>三者数据结构实际使用中的连接关系可能如下：<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzVlZjMxMWI3MWUwODUzMjYzNzQxNDc3Ny5wbmc=">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/BusList.png" alt=""></p>
<p>bus 和 device 以及 device_driver 下都有一个 private 或 subsys 结构用来处理一些共性的工作，是一种很好的抽象结构。</p>
<h2 id="实现"><a class="markdownIt-Anchor" href="#实现"></a> 实现</h2>
<p>好了到现在我们已经清楚最重要的三个数据结构之间的关系了，接下来是关于 device 和 device_driver 是如何匹配上的，device 和 device_driver 一个描述了设备一个是拥有驱动设备的方法，但是 linux 下设备非常多，每个设备都要有一个对应的驱动程序来驱动，下面详细看下 device 和 device_driver 的关联过程。</p>
<h3 id="device-的注册过程"><a class="markdownIt-Anchor" href="#device-的注册过程"></a> device 的注册过程</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">device_register</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">{</span><br><span class="line">	device_initialize(dev);</span><br><span class="line">	<span class="keyword">return</span> device_add(dev);</span><br><span class="line">}</span><br><span class="line">EXPORT_SYMBOL_GPL(device_register);</span><br></pre></td></tr></tbody></table></figure>
<p>初始化设备并将其添加到系统中。其中 device_initialize 初始化 device 结构体，主要是 kobject_init 初始化 kobj 结构体，其他就是初始化一些锁、链表指针之类的，重点是 device_add 这个函数，这个函数主要完成以下工作：</p>
<pre><code> 1. 初始化 device_private 结构体
 2. 使用 bus-&gt;dev_name + dev-&gt;id 为 dev-&gt;init_name 自动命名
 3. 增加 device 引用次数
 4. 如果没有 class，则子系统为设备指定默认的 root 路径 (bus-&gt;dev_root)
 5. kobject 名称在此函数中设置并添加到 kobject 层次结构中
 6. 通知新设备加入
 7. 为 device 创建 sysfs 文件
 8. 将 device 添加到 bus（将 dev-&gt;p-&gt;knode_bus 加入到 us-&gt;p-&gt;klist_devices)
 9. 创建 dev 目录
 10. 通知客户端有新设备添加
 11. 调用最重要的函数为 device_probe_driver
</code></pre>
<p>下面主要介绍 bus_probe_device 这个函数，由于函数调用层级较多，这里不打算将函数一一列出，而是梳理出调用关系，如下：<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxMTY4ODc1N2Q5YzA4MDZlNGFlZmUzOS5wbmc=">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/DeviceRegister.png" alt=""></p>
<p>这里需要注意的是 match 函数的实现是具体的 bus 实现的函数，例如 platform bus 会实现自己的 match 函数，后续会有文章进行介绍，关于 probe 函数，一般 bus 也会实现自己的 probe 函数，然后 bus 下的 probe 函数会调用 driver 数据结构的 probe 函数。</p>
<h3 id="driver-的注册过程"><a class="markdownIt-Anchor" href="#driver-的注册过程"></a> driver 的注册过程</h3>
<p>driver 的注册是通过 driver_register 该函数完成的，感兴趣的读者可以去阅读源码。同样关于 driver 的注册这里也贴一张图：<span class="exturl" data-url="aHR0cDovL2Fzc2V0cy5wcm9jZXNzb24uY29tL2NoYXJ0X2ltYWdlLzYxMTdjMmMzMGUzZTc0MDdkM2EwZjNhNy5wbmc=">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/DriverRegister.png" alt=""></p>
<p>driver 和 device 的注册类似，都会在自己挂载的 bus 上去遍历对方的所有设备或驱动然后进行遍历匹配，当匹配上了将两个数据结构关联然后调用 driver 的 probe 函数。而 driver 的 probe 函数也就是驱动程序的入口，用户需要实现的操作都在这个函数里实现。</p>
<h3 id="bus-的注册过程"><a class="markdownIt-Anchor" href="#bus-的注册过程"></a> bus 的注册过程</h3>
<p>上面已经将 device 和 driver 介绍完了，device 和 driver 都将注册到 bus，然后 bus 管理两个链表一个 device 链表一个 driver 链表，现在我们再看看 bus 数据本身的一注册过程。<br>
bus_register 函数完成 bus 的注册，该函数主要完成以下工作：</p>
<pre><code> 1. 为 subsys_private 分配内存空间
 2. 初始化 subsys_private 结构体，并将 bus-&gt;p 指向这块内存
 3. 设置 priv-&gt;subsys.kobj 的 name 为 bus-&gt;name
 4. 初始化 subsys_private 的 kobj、kset，ktype 结构体
 5. 注册 kset，会在 sysfs 文件系统下创建目录
 6. 向 bus 目录下添加一个 uevent attribute
 7. 分别向内核添加 devices 和 device_drivers kset，会体现在 sysfs 中
 8. 初始化 subsys_private 里的 mutex、klist_devices 和 klist_drivers 等变量
 9. 在 bus 下添加 drivers_probe 和 drivers_autoprobe 两个 attribute，如/sys/bus/spi/drivers_probe 和/sys/bus/spi/drivers_autoprobe），其中 drivers_probe 允许用户空间程序主动出发指定 bus 下的 device_driver 的 probe 动作，而 drivers_autoprobe 控制是否在 device 或 device_driver 添加到内核时，自动执行 probe
 10. 调用 bus_add_attrs，添加由 bus_attrs 指针定义的 bus 的默认 attribute，这些 attributes 最终会体现在/sys/bus/xxx 目录下
</code></pre>
<p>bus 的注册基本上是对自己内部的数据初始化以便于具体的 bus 结构体使用，例如 platform 总线进行使用。</p>
<h1 id="class"><a class="markdownIt-Anchor" href="#class"></a> class</h1>
<p>class 数据结构是一种抽象结构，class 是将一些共性的属性或操作提取出来单独成为一个数据结构以提高代码复用率减少重复代码。官方文档的描述是：</p>
<pre><code>A device class describes a type of device, like an audio or network device.
</code></pre>
<p>下面是 class 数据结构内容：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> {</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*name; <span class="comment">// class 的名称</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">class_attribute</span>		*<span class="title">class_attrs</span>;</span> <span class="comment">// class 的默认属性</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>	**<span class="title">dev_groups</span>;</span> <span class="comment">// 属于该 class 的 device 的默认属性</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span>			*<span class="title">dev_kobj</span>;</span> <span class="comment">// 代表该 class 的层级关系</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*dev_uevent)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> kobj_uevent_env *env); <span class="comment">// 当有设备添加到 class 或从 class 移除时调用</span></span><br><span class="line">	<span class="type">char</span> *(*devnode)(<span class="keyword">struct</span> device *dev, <span class="type">umode_t</span> *mode);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> (*class_release)(<span class="keyword">struct</span> class *class); <span class="comment">//class 销毁时调用</span></span><br><span class="line">	<span class="type">void</span> (*dev_release)(<span class="keyword">struct</span> device *dev); <span class="comment">//release 一个 device</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*suspend)(<span class="keyword">struct</span> device *dev, <span class="type">pm_message_t</span> state); <span class="comment">//休眠时调用</span></span><br><span class="line">	<span class="type">int</span> (*resume)(<span class="keyword">struct</span> device *dev); <span class="comment">//唤醒时调用</span></span><br><span class="line">	<span class="type">int</span> (*shutdown)(<span class="keyword">struct</span> device *dev); <span class="comment">//关机时调用</span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_ns_type_operations</span> *<span class="title">ns_type</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">void</span> *(*namespace)(<span class="keyword">struct</span> device *dev);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_ops</span> *<span class="title">pm</span>;</span> <span class="comment">//属于该 class 的 device 的默认电源管理操作</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subsys_private</span> *<span class="title">p</span>;</span> <span class="comment">//子系统，跟 bus 下的相同含义</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>其实这里 class 就是一个多设备容器，这个容器就是方便管理设备的（当然 bus 也是管理设备的数据结构，bus 是管理同一总线上的设备和设备驱动的），class 将设备进行分类管理（另一个维度，区别于 bus）并提供 api 方便驱动开发人员进行管理设备。</p>
<h1 id="uevent"><a class="markdownIt-Anchor" href="#uevent"></a> Uevent</h1>
<p>Uevent 是 Kobject 的一部分，用于在 Kobject 状态发生改变时，例如增加、移除等，通知用户空间程序。用户空间程序收到这样的事件后，会做相应的处理。该机制通常是用来支持热拔插设备的，从而动态的支持该设备。</p>
<h2 id="实现-2"><a class="markdownIt-Anchor" href="#实现-2"></a> 实现</h2>
<p>uevent 相关数据结构如下：<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWIwMjIwNzkxMjkwNmIyYTNmNDMx">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/uevent.png" alt=""></p>
<p>主要的实现函数就是 kobject_uevent 函数，如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">kobject_uevent</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">enum</span> kobject_action action)</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">return</span> kobject_uevent_env(kobj, action, <span class="literal">NULL</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>调用 kobject_uevent_env 函数：该函数主要完成以下工作：</p>
<pre><code> 1. 查找 kobj 本身或者其 parent 是否从属于某个 kset
 2. 该 kobject 不属于某个 kset，返回报错。如果一个 kobject 没有加入 kset，是不允许上报 uevent 的
 3. 查看 kobj-&gt;uevent_suppress 是否设置，如果设置，则忽略所有的 uevent 上报并返回。可以通过 Kobject 的 uevent_suppress 标志，管控 Kobject 的 uevent 的上报
 4. 如果所属的 kset 有 uevent_ops-&gt;filter 函数，则调用该函数，过滤此次上报，kset 可以通过 filter 接口过滤不希望上报的 event，从而达到整体的管理效果
 5. 判断所属的 kset 是否有合法的名称（称作 subsystem，和前期的内核版本有区别），否则不允许上报 uevent
 6. 分配一个用于此次上报的、存储环境变量的 buffer（结果保存在 env 指针中），并获得该 Kobject 在 sysfs 中路径信息（用户空间软件需要依据该路径信息在 sysfs 中访问它）
 7. 获取 kobject 完整路径
 8. 调用 add_uevent_var 接口，将 Action、路径信息、subsystem 等信息，添加到 env 指针中
 9. 如果传入的 envp_ext 不空，则解析传入的环境变量中，同样调用 add_uevent_var 接口，添加到 env 指针中
 10. 如果所属的 kset 存在 uevent_ops-&gt;uevent 接口，调用该接口，添加 kset 统一的环境变量到 env 指针
 11. 在对象中标记“添加”和“删除”事件，以确保在自动清理期间向用户空间发送适当的事件。如果对象确实发送了“添加”事件，则核心将自动生成“删除”，如果调用者尚未完成
 12. 用 add_uevent_var 接口，添加格式为"SEQNUM=%llu”的序列号
 13. 如果定义了"CONFIG_NET”，则使用 netlink 发送该 uevent
 13. 以 uevent_helper、subsystem 以及添加了标准环境变量（HOME=/，PATH=/sbin:/bin:/usr/sbin:/usr/bin）的 env 指针为参数
 14. 调用 kmod 模块提供的 call_usermodehelper 函数，上报 uevent。其中 uevent_helper 的内容是由内核配置项 CONFIG_UEVENT_HELPER_PATH（位于。/drivers/base/Kconfig) 决定的（可参考 lib/kobject_uevent.c, line 32)，该配置项指定了一个用户空间程序（或者脚本），用于解析上报的 uevent，例如"/sbin/hotplug”。call_usermodehelper 的作用，就是 fork 一个进程，以 uevent 为参数，执行 uevent_helper
</code></pre>
<p>在系统启动后，大部分的设备已经 ready，可以根据需要，重新指定一个 uevent helper，以便检测系统运行过程中的热拔插事件。这可以通过把 helper 的路径写入到"/sys/kernel/uevent_helper”文件中实现。实际上，内核通过 sysfs 文件系统的形式，将 uevent_helper 数组开放到用户空间，供用户空间程序修改访问，具体可参考"./kernel/sysfs.c”中相应的代码，这里不再详细描述。</p>
<h1 id="platfor-总线"><a class="markdownIt-Anchor" href="#platfor-总线"></a> platfor 总线</h1>
<h2 id="platform-数据结构"><a class="markdownIt-Anchor" href="#platform-数据结构"></a> platform 数据结构</h2>
<p>platform 数据结构同样是对 device、device_driver、bus 数据结构的再封装，我将 platform 的数据结构列出来如下：<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWIwOWE3ZDljMDg2NjUxM2VhMjgz">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/PlatformStruct.png" alt=""></p>
<h2 id="platform-总线实现"><a class="markdownIt-Anchor" href="#platform-总线实现"></a> platform 总线实现</h2>
<p>首先还是将数据结构之间的关系列出来，如下：<span class="exturl" data-url="aHR0cHM6Ly93d3cucHJvY2Vzc29uLmNvbS92aWV3L2xpbmsvNjE2OWIwYzNmMzQ2ZmIwNmE5ZjEzMjI1">原图<i class="fa fa-external-link-alt"></i></span><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/PlatformStruct.png" alt=""></p>
<p>上图将 platform 总线的实现概要列举出来，下面详细看看 platform 总线的几个重要函数：</p>
<ul>
<li>
<p>platform_probe:<br>
在上面介绍 device_driver 的时候介绍 register 的时候讲到 probe 函数的调用时机，在 device_driver 注册的时候会执行总线的 probe 函数，对于 platform 总线就是由 platform 总线再调用 device_driver 的 probe 函数</p>
</li>
<li>
<p>platform_match:<br>
这个函数提供了 4 种匹配规则，具体如下：</p>
<ul>
<li>driver_override 匹配：这个是最优先的匹配将 device 的 driver_override 和 device_driver 的 name 进行匹配</li>
<li>of_driver_match_device 匹配：这个把 device_driver 的 of_match_table 和 device 里的 of_node 进行匹配，of_node 由 dts 里的 compatible 字符串进行比较匹配</li>
<li>acpi_driver_match_device 匹配：acpi 匹配规则进行匹配，这个没详细看</li>
<li>platform_match_id 匹配：通过 platform_driver-&gt;id_table-&gt;name 和 platform_device-&gt;name 进行匹配</li>
</ul>
</li>
<li>
<p>platform_pm_suspend:<br>
在我们编写驱动的时候休眠唤醒是一个非常关键的操作，那么 platform 总线实现的休眠函数就是 platform_pm_suspend，platform 总线的 suspend 的实现就是调用 device_driver 的 suspend 函数，跟 probe 函数类似</p>
</li>
</ul>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>这里也说明了 platform 总线并没有操作具体实际的硬件，总线的实现就是调用驱动的具体函数。有了这些总线我们在实际编写驱动的时候就非常方便，我们只需要实现 device_driver 结构体里的具体函数然后将这个结构体注册到 platform 总线就完事了，具体函数的调用时机由总线负责，不需要驱动编写人员编写。</p>
<h1 id="参考文献"><a class="markdownIt-Anchor" href="#参考文献"></a> 参考文献</h1>
<p><span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvc29ydC9kZXZpY2VfbW9kZWw=">窝窝科技-设备驱动模型<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cDovL3d3dy53b3dvdGVjaC5uZXQvZGV2aWNlX21vZGVsL3VldmVudC5odG1s">窝窝科技-Linux 设备模型 (3)_Uevent<i class="fa fa-external-link-alt"></i></span><br>
《linux 内核文档》<br>
《linux 设备驱动开发》</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/picture/qrcode_for_gh_ef4ee2392948_258.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
              <a href="/tags/Driver/" rel="tag"><i class="fa fa-tag"></i> Driver</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Algorithm/focRelatedAlgorithms/" rel="prev" title="foc 相关算法">
                  <i class="fa fa-angle-left"></i> foc 相关算法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/LinuxDriver/LinuxDriverFileSystem/" rel="next" title="Linux 驱动之文件系统">
                  Linux 驱动之文件系统 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">CarlyleLiu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">512k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">31:03</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nhcmx5bGVsaXU=" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline.carlyleliu.vip","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"(发表评论)","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":["nick"],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/LinuxDriver/LinuxDriverDeviceModule/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
