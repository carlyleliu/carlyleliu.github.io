<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API | Matrix</title><meta name="author" content="CarlyleLiu"><meta name="copyright" content="CarlyleLiu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ğŸ˜Š There are two types of DMA mappingsConsistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that the">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API">
<meta property="og:url" content="https://carlyleliu.github.io/LinuxDriver/LinuxDriverBaseDMA-API/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="ğŸ˜Š There are two types of DMA mappingsConsistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that the">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://unsplash.it/1600/900?random&3638">
<meta property="article:published_time" content="2024-05-02T15:20:16.000Z">
<meta property="article:modified_time" content="2025-09-27T04:36:15.389Z">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Driver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://unsplash.it/1600/900?random&3638"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://carlyleliu.github.io/LinuxDriver/LinuxDriverBaseDMA-API/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":300},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-27 12:36:15'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">194</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">28</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://unsplash.it/1600/900?random&amp;3638')"><nav id="nav"><span id="blog-info"><a href="/" title="Matrix"><span class="site-name">Matrix</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-05-02T15:20:16.000Z" title="å‘è¡¨äº 2024-05-02 23:20:16">2024-05-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-09-27T04:36:15.389Z" title="æ›´æ–°äº 2025-09-27 12:36:15">2025-09-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/">Technology Blog</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/Linux/">Linux</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology-Blog/Linux/Driver/">Driver</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ğŸ˜Š-There-are-two-types-of-DMA-mappings"><a href="#ğŸ˜Š-There-are-two-types-of-DMA-mappings" class="headerlink" title="ğŸ˜Š There are two types of DMA mappings"></a>ğŸ˜Š There are two types of DMA mappings</h1><p>Consistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that the device and the CPU can access the data in parallel and will see updates made by each other without any explicit software flushing.</p>
<p>Streaming DMAï¼ˆéœ€è¦è½¯ä»¶æ¥ç»´æŠ¤ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped for one DMA transfer, unmapped right after it (unless you use dma<em>sync</em>* below) and for which hardware can optimize for sequential accesses.</p>
<span id="more"></span>
<h1 id="ğŸ˜„-DMA-Direction"><a href="#ğŸ˜„-DMA-Direction" class="headerlink" title="ğŸ˜„ DMA Direction:"></a>ğŸ˜„ DMA Direction:</h1><p><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma1.png" alt=""></p>
<p>The interfaces described in subsequent portions of this document take a DMA direction argument, which is an integer and takes on one of the following values:</p>
<ul>
<li>DMA_BIDIRECTIONAL</li>
<li>DMA_TO_DEVICE</li>
<li>DMA_FROM_DEVICE</li>
<li>DMA_NONE</li>
</ul>
<p>You should provide the exact DMA direction if you know it.</p>
<p>DMA_TO_DEVICE means â€œfrom main memory to the deviceâ€. DMA_FROM_DEVICE means â€œfrom the device to main memoryâ€. It is the direction in which the data moves during the DMA transfer.</p>
<p>You are <em>strongly</em> encouraged to specify this as precisely as you possibly can.</p>
<p>If you absolutely cannot know the direction of the DMA transfer, specify DMA_BIDIRECTIONAL.  It means that the DMA can go in either direction.  The platform guarantees that you may legally specify this, and that it will work, but this may be at the cost of performance for example.</p>
<p>The value DMA_NONE is to be used for debugging(DMA_NONE ç”¨äºè°ƒè¯•ï¼‰.  One can hold this in a data structure before you come to know the precise direction, and this will help catch cases where your direction tracking logic has failed to set things up properly.</p>
<p>Another advantage of specifying this value precisely (outside of potential platform-specific optimizations of such) is for debugging. Some platforms actually have a write permission boolean which DMA mappings can be marked with, much like page protections in the user program address space.  Such platforms can and do report errors in the kernel logs when the DMA controller hardware detects violation of the permission setting.</p>
<p>Only streaming mappings specify a direction, consistent mappings implicitly have a direction attribute setting of DMA_BIDIRECTIONAL.</p>
<p>For Networking drivers, itâ€™s a rather simple affair.  For transmit packets, map/unmap them with the DMA_TO_DEVICE direction specifier.  For receive packets, just the opposite, map/unmap them with the DMA_FROM_DEVICE direction specifier.</p>
<h1 id="ğŸ˜‹-dma-sync-single-for-device-cpu-API"><a href="#ğŸ˜‹-dma-sync-single-for-device-cpu-API" class="headerlink" title="ğŸ˜‹ dma_sync_single_for_device/cpu API"></a>ğŸ˜‹ dma_sync_single_for_device/cpu API</h1><p><em>è°ƒç”¨æ ˆï¼š</em>   </p>
<figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dma_sync_single_for_device/cpu</span><br><span class="line">    --&gt;dma_direct_sync_single_for_device/cpu</span><br><span class="line">        --&gt;arch_sync_dma_for_device/cpu</span><br><span class="line">            --&gt;_dma_map_area/__dma_unmap_area --&gt; dcache_clean_poc/dcache_inval_poc</span><br></pre></td></tr></tbody></table></figure>
<h2 id="stuck-out-tongue-winking-eye-å¯¹äº-Linux-upstream-ç¤¾åŒº"><a href="#stuck-out-tongue-winking-eye-å¯¹äº-Linux-upstream-ç¤¾åŒº" class="headerlink" title=":stuck_out_tongue_winking_eye: å¯¹äº Linux upstream ç¤¾åŒº"></a><span class="github-emoji"><span>ğŸ˜œ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f61c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¯¹äº Linux upstream ç¤¾åŒº</h2><h3 id="kernel-5-x"><a href="#kernel-5-x" class="headerlink" title="kernel 5.x"></a>kernel 5.x</h3><p>arch_sync_dma_for_device å…¨éƒ¨æ‰§è¡Œ clean cache<br>arch_sync_dma_for_device å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšå¦åˆ™æ‰§è¡Œ invalid cache</p>
<p><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma2.png" alt=""><br><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma3.png" alt=""></p>
<h3 id="kernel-6-x"><a href="#kernel-6-x" class="headerlink" title="kernel 6.x"></a>kernel 6.x</h3><p>åœ¨ arch_sync_dma_for_device ä¸­ direction è¢«å¿½ç•¥æ‰ï¼Œæ‰§è¡Œ dcache_clean_poc(clean cache)<br>åœ¨ arch_sync_dma_for_cpu ä¸­ dir ä¸º DMA_TO_DEVICE ä»€ä¹ˆä¹Ÿä¸åšç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œ dcache_inval_pocï¼ˆinvalid cacheï¼‰</p>
<p><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma4.png" alt=""></p>
<h2 id="å¯¹äº-Google-ç¤¾åŒº"><a href="#å¯¹äº-Google-ç¤¾åŒº" class="headerlink" title="å¯¹äº Google ç¤¾åŒº"></a>å¯¹äº Google ç¤¾åŒº</h2><h3 id="kernel-5-x-1"><a href="#kernel-5-x-1" class="headerlink" title="kernel 5.x"></a>kernel 5.x</h3><p><strong>dma_map_area(): å¦‚æœ direction æ˜¯ DMA_FROM_DEVICE åˆ™å…ˆæ‰§è¡Œä¸€ä¸ª fluah æ“ä½œï¼Œç„¶åæ‰§è¡Œ clean cacheï¼Œå¦‚æœ direction ä¸æ˜¯ DMA_FROM_DEVICE åˆ™åªæ‰§è¡Œ clean cache
</strong>dma_unmap_area(): å¦‚æœ direction ç­‰äº DMA_TO_DEVICE ä»€ä¹ˆä¹Ÿä¸åšå¦åˆ™æ‰§è¡Œ__dma_inv_area(invalid cache)<br><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma5.png" alt=""></p>
<h3 id="kernel-6-x-1"><a href="#kernel-6-x-1" class="headerlink" title="kernel 6.x"></a>kernel 6.x</h3><p>for_device å¿½ç•¥ directionã€å…¨éƒ¨ direction æ‰§è¡Œ clean cache<br>for_cpu å¿½ç•¥ DMA_TO_DEVICE, å…¶ä»– direction æ‰§è¡Œ invalid cache<br><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma6.png" alt=""></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="Linux-upstream"><a href="#Linux-upstream" class="headerlink" title="Linux upstream"></a>Linux upstream</h3><p><em>kernel 5.x:</em>   </p>
<p>dma_sync_single_for_deviceï¼š å¿½ç•¥ direction å…¨éƒ¨æ‰§è¡Œ clean cache<br>dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cache</p>
<p><em>kernel 6.x:</em> </p>
<p>åŒ kernel 5.x é€»è¾‘ä¸€è‡´ï¼Œåªæ˜¯æ”¹äº†ä¸‹ api åç§°</p>
<h3 id="Google-ç¤¾åŒº"><a href="#Google-ç¤¾åŒº" class="headerlink" title="Google ç¤¾åŒº"></a>Google ç¤¾åŒº</h3><p><em>kernel 5.x:</em>   </p>
<p>dma_sync_single_for_deviceï¼š å¦‚æœ direction æ˜¯ DMA_FROM_DEVICE åˆ™å¤šæ‰§è¡Œä¸€ä¸ª flush cacheï¼Œå…¨éƒ¨ direction éƒ½ä¼šæ‰§è¡Œ clean cache<br>dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cacheï¼ˆåŒ linux upstream é€»è¾‘ä¸€è‡´ï¼‰   </p>
<p><em>kernel 6.x:</em> </p>
<p>åŒ linux upstream é€»è¾‘ä¸€è‡´   </p>
<p>dma_sync_single_for_deviceï¼š å¿½ç•¥ direction å…¨éƒ¨æ‰§è¡Œ clean cache<br>dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cache   </p>
<h1 id="ğŸ¦-QA"><a href="#ğŸ¦-QA" class="headerlink" title="ğŸ¦ QA"></a>ğŸ¦ QA</h1><p><strong>Qï¼š</strong> åœ¨ cache å’Œ ddr ä¸­çš„æ•°æ®ä¸€è‡´åï¼ŒDMA å°† device æ•°æ®æ¬è¿åˆ° ddr åï¼ˆcache ä¸ ddr ä¸ä¸€æ ·ï¼‰å¦‚æœè°ƒç”¨ flush æ¥å£ï¼Œflush å…ˆåš clean æ“ä½œä¼šä¸ä¼šå°† cache ä¸­çš„æ•°æ®å†™å› DDR.<br><strong>Aï¼š</strong> ä¸ä¼šã€‚clean æ“ä½œæ˜¯æ£€æŸ¥ dirty æ ‡å¿—ä½ï¼Œåœ¨ç¡¬ä»¶æ”¹å†™è¿‡ç¨‹ä¸­ dirty æ ‡å¿—ä½ä¸€ç›´æ˜¯ 0ï¼ˆé dirtyï¼‰ï¼Œæ‰€ä»¥æ­¤æ—¶ flush æ“ä½œä¸­çš„ clean æ“ä½œåªæ˜¯æ£€æŸ¥ä¸€é dirty bit, ä¹‹ååš invalid æ“ä½œã€‚</p>
<h1 id="ğŸ­-å‚è€ƒæ–‡çŒ®"><a href="#ğŸ­-å‚è€ƒæ–‡çŒ®" class="headerlink" title="ğŸ­ å‚è€ƒæ–‡çŒ®"></a>ğŸ­ å‚è€ƒæ–‡çŒ®</h1><p>ã€ŠLinux Documentã€‹   </p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/Driver/">Driver</a></div><div class="post_share"><div class="social-share" data-image="https://unsplash.it/1600/900?random&amp;3638" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/LinuxDriver/LinuxUSBUACASYNCFeedback/" title="UACï¼ˆä¸ƒï¼‰Async Feedback"><img class="cover" src="https://unsplash.it/1600/900?random&amp;7208" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">UACï¼ˆä¸ƒï¼‰Async Feedback</div></div></a></div><div class="next-post pull-right"><a href="/LinuxDriver/LinuxDriverBaseDeviceIO/" title="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I/O"><img class="cover" src="https://unsplash.it/1600/900?random&amp;1641" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I/O</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/LinuxDriver/LinuxDriverBaseDeviceIO/" title="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I&#x2F;O"><img class="cover" src="https://unsplash.it/1600/900?random&1641" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-22</div><div class="title">Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I&#x2F;O</div></div></a></div><div><a href="/LinuxDriver/LinuxDriverDeviceModule/" title="Linux é©±åŠ¨ä¹‹è®¾å¤‡é©±åŠ¨æ¨¡å‹"><img class="cover" src="https://unsplash.it/1600/900?random&7938" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-07</div><div class="title">Linux é©±åŠ¨ä¹‹è®¾å¤‡é©±åŠ¨æ¨¡å‹</div></div></a></div><div><a href="/LinuxDriver/LinuxDriverDeviceTree/" title="Linux é©±åŠ¨ä¹‹è®¾å¤‡æ ‘"><img class="cover" src="https://unsplash.it/1600/900?random&9232" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-25</div><div class="title">Linux é©±åŠ¨ä¹‹è®¾å¤‡æ ‘</div></div></a></div><div><a href="/LinuxDriver/LinuxDriverCCF/" title="Linux é©±åŠ¨ä¹‹ CCF å­ç³»ç»Ÿ"><img class="cover" src="https://unsplash.it/1600/900?random&890" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-05</div><div class="title">Linux é©±åŠ¨ä¹‹ CCF å­ç³»ç»Ÿ</div></div></a></div><div><a href="/LinuxDriver/LinuxDriverFileSystem/" title="Linux é©±åŠ¨ä¹‹æ–‡ä»¶ç³»ç»Ÿ"><img class="cover" src="https://unsplash.it/1600/900?random&7897" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-08</div><div class="title">Linux é©±åŠ¨ä¹‹æ–‡ä»¶ç³»ç»Ÿ</div></div></a></div><div><a href="/LinuxDriver/LinuxDriverGPIO/" title="Linux é©±åŠ¨ä¹‹ GPIO å­ç³»ç»Ÿ"><img class="cover" src="https://unsplash.it/1600/900?random&4238" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-05</div><div class="title">Linux é©±åŠ¨ä¹‹ GPIO å­ç³»ç»Ÿ</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">CarlyleLiu</div><div class="author-info__description">CarlyleLiuâ€™s Blog</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">194</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">42</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">28</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/carlyleliu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/carlyleliu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:yyliushuai@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-envelope" style="color: #24292e;"></i></a><a class="social-icon" href="https://twitter.com/yyliushuai" target="_blank" title="Twitter"><i class="fab fa-twitter" style="color: #24292e;"></i></a><a class="social-icon" href="https://youtube.com/carlyleliu" target="_blank" title="YouTube"><i class="fab fa-youtube" style="color: #24292e;"></i></a><a class="social-icon" href="https://instagram.com/blurredliu" target="_blank" title="Instagram"><i class="fab fa-instagram" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">nextä¸»é¢˜ç«™ https://carlyleliu.github.io/next</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%98%8A-There-are-two-types-of-DMA-mappings"><span class="toc-number">1.</span> <span class="toc-text">ğŸ˜Š There are two types of DMA mappings</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%98%84-DMA-Direction"><span class="toc-number">2.</span> <span class="toc-text">ğŸ˜„ DMA Direction:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%98%8B-dma-sync-single-for-device-cpu-API"><span class="toc-number">3.</span> <span class="toc-text">ğŸ˜‹ dma_sync_single_for_device&#x2F;cpu API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#stuck-out-tongue-winking-eye-%E5%AF%B9%E4%BA%8E-Linux-upstream-%E7%A4%BE%E5%8C%BA"><span class="toc-number">3.1.</span> <span class="toc-text">ğŸ˜œ å¯¹äº Linux upstream ç¤¾åŒº</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-5-x"><span class="toc-number">3.1.1.</span> <span class="toc-text">kernel 5.x</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-6-x"><span class="toc-number">3.1.2.</span> <span class="toc-text">kernel 6.x</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E-Google-%E7%A4%BE%E5%8C%BA"><span class="toc-number">3.2.</span> <span class="toc-text">å¯¹äº Google ç¤¾åŒº</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-5-x-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">kernel 5.x</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-6-x-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">kernel 6.x</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">æ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux-upstream"><span class="toc-number">3.3.1.</span> <span class="toc-text">Linux upstream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Google-%E7%A4%BE%E5%8C%BA"><span class="toc-number">3.3.2.</span> <span class="toc-text">Google ç¤¾åŒº</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%8D%A6-QA"><span class="toc-number">4.</span> <span class="toc-text">ğŸ¦ QA</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%F0%9F%8D%AD-%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">5.</span> <span class="toc-text">ğŸ­ å‚è€ƒæ–‡çŒ®</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2025 By CarlyleLiu</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="ä¸»é¢˜ç‰ˆæœ¬Butterfly" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('å·²æŒ‚è½½butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>