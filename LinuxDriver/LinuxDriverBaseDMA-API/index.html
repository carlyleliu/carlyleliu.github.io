<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="5txRYykRNG5Z1NrO_ZCLF1GZWnbFmCOLdJHGBVFuCIg">
  <meta name="baidu-site-verification" content="code-XfgDErPTZS">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reddit+Mono:300,300italic,400,400italic,700,700italic%7CNoto+Sans:300,300italic,400,400italic,700,700italic%7COpen+Sans:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/black/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"carlyleliu.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":true,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"hide","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ğŸ˜Š There are two types of DMA mappings Consistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that t">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API">
<meta property="og:url" content="https://carlyleliu.github.io/LinuxDriver/LinuxDriverBaseDMA-API/index.html">
<meta property="og:site_name" content="Matrix">
<meta property="og:description" content="ğŸ˜Š There are two types of DMA mappings Consistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that t">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma1.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma2.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma3.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma4.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma5.png">
<meta property="og:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma6.png">
<meta property="article:published_time" content="2024-05-02T15:20:16.000Z">
<meta property="article:modified_time" content="2025-09-27T03:40:43.583Z">
<meta property="article:author" content="CarlyleLiu">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="Driver">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma1.png">


<link rel="canonical" href="https://carlyleliu.github.io/LinuxDriver/LinuxDriverBaseDMA-API/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://carlyleliu.github.io/LinuxDriver/LinuxDriverBaseDMA-API/","path":"LinuxDriver/LinuxDriverBaseDMA-API/","title":"Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API | Matrix</title>
  







<link rel="dns-prefetch" href="https://waline.carlyleliu.vip">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Matrix" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Matrix</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">CarlyleLiuâ€˜s Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li><li class="menu-item menu-item-alist"><span class="exturl" data-url="aHR0cHM6Ly9hbGlzdC5jYXJseWxlbGl1LnZpcC8="><i class="fa-solid fa-cloud fa-fw"></i>ç½‘ç›˜</span></li><li class="menu-item menu-item-books"><span class="exturl" data-url="aHR0cHM6Ly9jYWxpYnJlLmNhcmx5bGVsaXUudmlwLw=="><i class="fa-solid fa-book fa-fw"></i>ä¹¦åº“</span></li><li class="menu-item menu-item-talk"><span class="exturl" data-url="aHR0cHM6Ly9tZW1vcy5jYXJseWxlbGl1LnZpcC9leHBsb3JlLw=="><i class="fas fa-comments fa-fw"></i>éšç¬”</span></li><li class="menu-item menu-item-album"><span class="exturl" data-url="aHR0cHM6Ly9pbW1pY2guY2FybHlsZWxpdS52aXAvc2hhcmUvSmtSenVqZERfdWVJRnJRNHpvYnpfUW1EVndRZkdGS3ZyVTh0ZlJIYWN1ZG9ZMjV0Z2tFdDd6aS1Wck5oYUEzZUdpNC8="><i class="fa-solid fa-image fa-fw"></i>ç›¸å†Œ</span></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="æœç´¢..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#there-are-two-types-of-dma-mappings"><span class="nav-text"> ğŸ˜Š There are two types of DMA mappings</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dma-direction"><span class="nav-text"> ğŸ˜„ DMA Direction:</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dma_sync_single_for_devicecpu-api"><span class="nav-text"> ğŸ˜‹ dma_sync_single_for_device&#x2F;cpu API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E4%BA%8E-linux-upstream-%E7%A4%BE%E5%8C%BA"><span class="nav-text"> ğŸ˜œ å¯¹äº Linux upstream ç¤¾åŒº</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-5x"><span class="nav-text"> kernel 5.x</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-6x"><span class="nav-text"> kernel 6.x</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E4%BA%8E-google-%E7%A4%BE%E5%8C%BA"><span class="nav-text"> å¯¹äº Google ç¤¾åŒº</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-5x-2"><span class="nav-text"> kernel 5.x</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-6x-2"><span class="nav-text"> kernel 6.x</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text"> æ€»ç»“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#linux-upstream"><span class="nav-text"> Linux upstream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#google-%E7%A4%BE%E5%8C%BA"><span class="nav-text"> Google ç¤¾åŒº</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#qa"><span class="nav-text"> ğŸ¦ QA</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text"> ğŸ­ å‚è€ƒæ–‡çŒ®</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CarlyleLiu</p>
  <div class="site-description" itemprop="description">CarlyleLiuâ€™s Blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">207</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nhcmx5bGVsaXU=" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;carlyleliu"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOnl5bGl1c2h1YWlAZ21haWwuY29t" title="E-Mail â†’ mailto:yyliushuai@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95eWxpdXNodWFp" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;yyliushuai"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly95b3V0dWJlLmNvbS9jYXJseWxlbGl1" title="YouTube â†’ https:&#x2F;&#x2F;youtube.com&#x2F;carlyleliu"><i class="fab fa-youtube fa-fw"></i>YouTube</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9pbnN0YWdyYW0uY29tL2JsdXJyZWRsaXU=" title="Instagram â†’ https:&#x2F;&#x2F;instagram.com&#x2F;blurredliu"><i class="fab fa-instagram fa-fw"></i>Instagram</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://carlyleliu.github.io/LinuxDriver/LinuxDriverBaseDMA-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CarlyleLiu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Matrix">
      <meta itemprop="description" content="CarlyleLiuâ€™s Blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API | Matrix">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆäºŒï¼‰DMA-API
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology-Blog/" itemprop="url" rel="index"><span itemprop="name">Technology Blog</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology-Blog/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
          ï¼Œ
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology-Blog/Linux/Driver/" itemprop="url" rel="index"><span itemprop="name">Driver</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Walineï¼š</span>
  
    <a title="waline" href="/LinuxDriver/LinuxDriverBaseDMA-API/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/LinuxDriver/LinuxDriverBaseDMA-API/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>824</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="there-are-two-types-of-dma-mappings"><a class="markdownIt-Anchor" href="#there-are-two-types-of-dma-mappings"></a> ğŸ˜Š There are two types of DMA mappings</h1>
<p>Consistent DMï¼ˆç¡¬ä»¶ä¿è¯ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped at driver initialization, unmapped at the end and for which the hardware should guarantee that the device and the CPU can access the data in parallel and will see updates made by each other without any explicit software flushing.</p>
<p>Streaming DMAï¼ˆéœ€è¦è½¯ä»¶æ¥ç»´æŠ¤ cache ä¸€è‡´æ€§ï¼‰ mappings which are usually mapped for one DMA transfer, unmapped right after it (unless you use dma_sync_* below) and for which hardware can optimize for sequential accesses.</p>
<span id="more"></span>
<h1 id="dma-direction"><a class="markdownIt-Anchor" href="#dma-direction"></a> ğŸ˜„ DMA Direction:</h1>
<p><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma1.png" alt=""></p>
<p>The interfaces described in subsequent portions of this document take a DMA direction argument, which is an integer and takes on one of the following values:</p>
<ul>
<li>DMA_BIDIRECTIONAL</li>
<li>DMA_TO_DEVICE</li>
<li>DMA_FROM_DEVICE</li>
<li>DMA_NONE</li>
</ul>
<p>You should provide the exact DMA direction if you know it.</p>
<p>DMA_TO_DEVICE means â€œfrom main memory to the deviceâ€. DMA_FROM_DEVICE means â€œfrom the device to main memoryâ€. It is the direction in which the data moves during the DMA transfer.</p>
<p>You are <em>strongly</em> encouraged to specify this as precisely as you possibly can.</p>
<p>If you absolutely cannot know the direction of the DMA transfer, specify DMA_BIDIRECTIONAL.  It means that the DMA can go in either direction.  The platform guarantees that you may legally specify this, and that it will work, but this may be at the cost of performance for example.</p>
<p>The value DMA_NONE is to be used for debugging(DMA_NONE ç”¨äºè°ƒè¯•ï¼‰.  One can hold this in a data structure before you come to know the precise direction, and this will help catch cases where your direction tracking logic has failed to set things up properly.</p>
<p>Another advantage of specifying this value precisely (outside of potential platform-specific optimizations of such) is for debugging. Some platforms actually have a write permission boolean which DMA mappings can be marked with, much like page protections in the user program address space.  Such platforms can and do report errors in the kernel logs when the DMA controller hardware detects violation of the permission setting.</p>
<p>Only streaming mappings specify a direction, consistent mappings implicitly have a direction attribute setting of DMA_BIDIRECTIONAL.</p>
<p>For Networking drivers, itâ€™s a rather simple affair.  For transmit packets, map/unmap them with the DMA_TO_DEVICE direction specifier.  For receive packets, just the opposite, map/unmap them with the DMA_FROM_DEVICE direction specifier.</p>
<h1 id="dma_sync_single_for_devicecpu-api"><a class="markdownIt-Anchor" href="#dma_sync_single_for_devicecpu-api"></a> ğŸ˜‹ dma_sync_single_for_device/cpu API</h1>
<p><em>è°ƒç”¨æ ˆï¼š</em></p>
<figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dma_sync_single_for_device/cpu</span><br><span class="line">    --&gt;dma_direct_sync_single_for_device/cpu</span><br><span class="line">        --&gt;arch_sync_dma_for_device/cpu</span><br><span class="line">            --&gt;_dma_map_area/__dma_unmap_area --&gt; dcache_clean_poc/dcache_inval_poc</span><br></pre></td></tr></tbody></table></figure>
<h2 id="å¯¹äº-linux-upstream-ç¤¾åŒº"><a class="markdownIt-Anchor" href="#å¯¹äº-linux-upstream-ç¤¾åŒº"></a> ğŸ˜œ å¯¹äº Linux upstream ç¤¾åŒº</h2>
<h3 id="kernel-5x"><a class="markdownIt-Anchor" href="#kernel-5x"></a> kernel 5.x</h3>
<p>arch_sync_dma_for_device å…¨éƒ¨æ‰§è¡Œ clean cache<br>
arch_sync_dma_for_device å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšå¦åˆ™æ‰§è¡Œ invalid cache</p>
<p><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma2.png" alt=""><br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma3.png" alt=""></p>
<h3 id="kernel-6x"><a class="markdownIt-Anchor" href="#kernel-6x"></a> kernel 6.x</h3>
<p>åœ¨ arch_sync_dma_for_device ä¸­ direction è¢«å¿½ç•¥æ‰ï¼Œæ‰§è¡Œ dcache_clean_poc(clean cache)<br>
åœ¨ arch_sync_dma_for_cpu ä¸­ dir ä¸º DMA_TO_DEVICE ä»€ä¹ˆä¹Ÿä¸åšç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œ dcache_inval_pocï¼ˆinvalid cacheï¼‰</p>
<p><img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma4.png" alt=""></p>
<h2 id="å¯¹äº-google-ç¤¾åŒº"><a class="markdownIt-Anchor" href="#å¯¹äº-google-ç¤¾åŒº"></a> å¯¹äº Google ç¤¾åŒº</h2>
<h3 id="kernel-5x-2"><a class="markdownIt-Anchor" href="#kernel-5x-2"></a> kernel 5.x</h3>
<p>__dma_map_area(): å¦‚æœ direction æ˜¯ DMA_FROM_DEVICE åˆ™å…ˆæ‰§è¡Œä¸€ä¸ª fluah æ“ä½œï¼Œç„¶åæ‰§è¡Œ clean cacheï¼Œå¦‚æœ direction ä¸æ˜¯ DMA_FROM_DEVICE åˆ™åªæ‰§è¡Œ clean cache<br>
__dma_unmap_area(): å¦‚æœ direction ç­‰äº DMA_TO_DEVICE ä»€ä¹ˆä¹Ÿä¸åšå¦åˆ™æ‰§è¡Œ__dma_inv_area(invalid cache)<br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma5.png" alt=""></p>
<h3 id="kernel-6x-2"><a class="markdownIt-Anchor" href="#kernel-6x-2"></a> kernel 6.x</h3>
<p>for_device å¿½ç•¥ directionã€å…¨éƒ¨ direction æ‰§è¡Œ clean cache<br>
for_cpu å¿½ç•¥ DMA_TO_DEVICE, å…¶ä»– direction æ‰§è¡Œ invalid cache<br>
<img src="https://lsky.carlyleliu.vip/carlyleliu/ImageHosting/TechnologyBlog/Linux/Driver/dma6.png" alt=""></p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<h3 id="linux-upstream"><a class="markdownIt-Anchor" href="#linux-upstream"></a> Linux upstream</h3>
<p><em>kernel 5.x:</em></p>
<p>dma_sync_single_for_deviceï¼š å¿½ç•¥ direction å…¨éƒ¨æ‰§è¡Œ clean cache<br>
dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cache</p>
<p><em>kernel 6.x:</em></p>
<p>åŒ kernel 5.x é€»è¾‘ä¸€è‡´ï¼Œåªæ˜¯æ”¹äº†ä¸‹ api åç§°</p>
<h3 id="google-ç¤¾åŒº"><a class="markdownIt-Anchor" href="#google-ç¤¾åŒº"></a> Google ç¤¾åŒº</h3>
<p><em>kernel 5.x:</em></p>
<p>dma_sync_single_for_deviceï¼š å¦‚æœ direction æ˜¯ DMA_FROM_DEVICE åˆ™å¤šæ‰§è¡Œä¸€ä¸ª flush cacheï¼Œå…¨éƒ¨ direction éƒ½ä¼šæ‰§è¡Œ clean cache<br>
dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cacheï¼ˆåŒ linux upstream é€»è¾‘ä¸€è‡´ï¼‰</p>
<p><em>kernel 6.x:</em></p>
<p>åŒ linux upstream é€»è¾‘ä¸€è‡´</p>
<p>dma_sync_single_for_deviceï¼š å¿½ç•¥ direction å…¨éƒ¨æ‰§è¡Œ clean cache<br>
dma_sync_single_for_cpuï¼š å¦‚æœ direction æ˜¯ DMA_TO_DEVICE åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™æ‰§è¡Œ invalid cache</p>
<h1 id="qa"><a class="markdownIt-Anchor" href="#qa"></a> ğŸ¦ QA</h1>
<p><strong>Qï¼š</strong> åœ¨ cache å’Œ ddr ä¸­çš„æ•°æ®ä¸€è‡´åï¼ŒDMA å°† device æ•°æ®æ¬è¿åˆ° ddr åï¼ˆcache ä¸ ddr ä¸ä¸€æ ·ï¼‰å¦‚æœè°ƒç”¨ flush æ¥å£ï¼Œflush å…ˆåš clean æ“ä½œä¼šä¸ä¼šå°† cache ä¸­çš„æ•°æ®å†™å› DDR.<br>
<strong>Aï¼š</strong> ä¸ä¼šã€‚clean æ“ä½œæ˜¯æ£€æŸ¥ dirty æ ‡å¿—ä½ï¼Œåœ¨ç¡¬ä»¶æ”¹å†™è¿‡ç¨‹ä¸­ dirty æ ‡å¿—ä½ä¸€ç›´æ˜¯ 0ï¼ˆé dirtyï¼‰ï¼Œæ‰€ä»¥æ­¤æ—¶ flush æ“ä½œä¸­çš„ clean æ“ä½œåªæ˜¯æ£€æŸ¥ä¸€é dirty bit, ä¹‹ååš invalid æ“ä½œã€‚</p>
<h1 id="å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡çŒ®"></a> ğŸ­ å‚è€ƒæ–‡çŒ®</h1>
<p>ã€ŠLinux Documentã€‹</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="followme">
  <span>æ¬¢è¿å…³æ³¨æˆ‘çš„å…¶å®ƒå‘å¸ƒæ¸ é“</span>

  <div class="social-list">

      <div class="social-item">
          <span class="social-link">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </span>

          <img class="social-item-img" src="/picture/qrcode_for_gh_ef4ee2392948_258.jpg">
      </div>

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"><i class="fa fa-tag"></i> Linux</a>
              <a href="/tags/Driver/" rel="tag"><i class="fa fa-tag"></i> Driver</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/LinuxDriver/LinuxDriverBaseDeviceIO/" rel="prev" title="Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I/O">
                  <i class="fa fa-angle-left"></i> Linux é©±åŠ¨ä¹‹åŸºç¡€ï¼ˆä¸€ï¼‰Device-I/O
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/LinuxDriver/LinuxUSBUACASYNCFeedback/" rel="next" title="UACï¼ˆä¸ƒï¼‰Async Feedback">
                  UACï¼ˆä¸ƒï¼‰Async Feedback <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2018 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">CarlyleLiu</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">488k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">29:35</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nhcmx5bGVsaXU=" title="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘" aria-label="åœ¨ GitHub ä¸Šå…³æ³¨æˆ‘"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline.carlyleliu.vip","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"(å‘è¡¨è¯„è®º)","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":["nick"],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/LinuxDriver/LinuxDriverBaseDMA-API/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
